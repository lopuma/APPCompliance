       *
      /`\ 
     /   \
  ,,´¨¨¨¨¨`,,
    (* _ *) 
     (   )
   /(     )\
  m (     ) m
   Oo.   .oO
/********************************************************************************************************************************************************************/
AV.1.1.1 Password Requirements	"PermitEmptyPasswords" = no

cat /etc/ssh/sshd_config | grep -i PermitEmptypassword

#"Si sale comentado mirar el MAN y ver el default"

man sshd_config
/PermitEmptyPasswords
/********************************************************************************************************************************************************************/
AV.1.1.4 Password Requirements	Private Key Passphrases	A passphrase must be assigned to all private keys that are used for user authentication and must not be shared.

#" las claves privadas deben ser solor del owner y debe tener un fichero id_rsa (Passphrases)"#

ls -l $HOME/.ssh/*
ls -la /home/*/.ssh/* | grep -i "id_rsa"

Incorrect the user in the file:  : -rw-------    1 7033     ibmldadm        401 Oct 28 2015  /home/esy9babh/.ssh/id_rsa.pub

/********************************************************************************************************************************************************************/
##AV.1.1.5 Password Requirements	Private Key Passphrases
##AV.1.1.6 Password Requirements
# YES Informativo
#SIMILAR 
##AV.2.2.1.2 Passphrases
##AV.2.2.1.3 Passphrases
/********************************************************************************************************************************************************************/
AV.1.1.7 Password Requirements	Private Key Passphrases - security administrative and system authority

#"Cualquier archivo authorized_keys o authorized_keys2 que otorga acceso a un ID que tenga autoridad administrativa o de sistema de seguridad debe limitar el acceso sólo desde hosts específicos especificando la opción "from" con el valor adecuado."

ls -l $HOME/.ssh/*
ls -la /home/*/.ssh/* | grep -i authorized

#"Ejemplo de ficheros uthorized_keys o authorized_keys2"
-rw-------    1 ES083125 ibmldtiv        269 Oct 07 2015 /home/ES083125/.ssh/authorized_keys

#"Comprobar que el owner sea el mismo y que solo tenga permisos para el owner, si aun seguimos con dudas, al hacer un CAT"

[es06ram03sr01xg:root:/home/root:] cat /home/ES083125/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAIEAhN/z50XN5W8hbqEsU6mUts6DZ8iuIP7xNexvMYsYo6Ebx+WMST1q0lDKG6W3zruNeAlfZ4sY2bixNGQnZtXcj/wdQl9Bd9XhsvAm+P5D4V1GiZRpdqTxGIg6IM4ws+S1NZCvx/JgzrMU7s/TiozgdKlTISdyAL2KywTo40tfFDE= rsa-key-20101124 !!ES/I/083125/IBM/Marco.Hermosilla.Beraz!!


#"Vemos que al final esta limitado solo el acceso a esa clave para el owner o bien podria tener un FROM al principio que lo limita"


#"Comprobar que el usuario que salte para desvio no exista"#
cat /etc/passwd | grep -i ES080766
cat /etc/shadow | grep -i ES080766
getent passwd ES080766

Incorrect the user in the file:  : 

-rw-------    1 7033     ibmldadm        406 Oct 28 2015  /home/esy9babh/.ssh/authorized_keys
-rw-r--r--    1 root     sys             409 Oct 06 2015  /home/esy9babh/.ssh/authorized_keys.backup
-r--------    1 150      automata        874 Mar 17 2017  /home/icouxat1/.ssh/authorized_keys
-r--------    1 151      automata        874 Mar 17 2017  /home/icouxat2/.ssh/authorized_keys


/********************************************************************************************************************************************************************/
AV.1.2.1.2 Logging 	"LogLevel"
AV.1.2.1.3 Logging 	"LogLevel"

cat /etc/ssh/sshd_config | grep -i logLevel

#"Si sale comentado mirar el MAN y ver el default"

man sshd_config
/LogLevel
/********************************************************************************************************************************************************************/
AV.1.2.2 Logging 	"QuietMode"

"Specifies that only fatal errors should be logged.
(F-Secure/SSH Communications Only - OS: Unix, Linux)"

#"N/A OpenSSH"
/********************************************************************************************************************************************************************/
AV.1.2.4 Logging 	Retain Log Files	90 days

#->Logrotate<-#
cat /etc/logrotate.conf

#->sinofunciona,mirar,logkeeper<-#
/usr/util/seguridad/logkeeper -s

#->sinLOGKEEPE&&&sinLOGROTATE<-#
cat /usr/local/bin/tareas/rotalogs.ksh | grep -i /var/adm
/********************************************************************************************************************************************************************/
AV.1.4.1 System Settings	"KeepAlive"

#"Aplica si es OpenSSHV3.7 y inferior"#
ssh -V

#"N/A openSSH"#
/********************************************************************************************************************************************************************/
AV.1.4.2 System Settings	"TCPKeepAlive" = YES

cat /etc/ssh/sshd_config | grep -i TCPKeepAlive

#"Si sale comentado mirar el MAN y ver el default"

man sshd_config
/TCPKeepAlive
/********************************************************************************************************************************************************************/
AV.1.4.3 System Settings	"LoginGraceTime" = 120 or less and must not be 0 
 
cat /etc/ssh/sshd_config | grep -i LoginGraceTime

#"Si sale comentado mirar el MAN y ver el default"

man sshd_config
/LoginGraceTime
/********************************************************************************************************************************************************************/
AV.1.4.4 System Settings	"MaxConnections"

#"N/A openSSH"#
/********************************************************************************************************************************************************************/
AV.1.4.8 System Settings	"MaxAuthTries" = "100 or less"
cat /etc/ssh/sshd_config | grep -i MaxStartups

#"Si sale comentado mirar el MAN y ver el default"

man sshd_config
/MaxStartups
/********************************************************************************************************************************************************************/
AV.1.4.14 System Settings	AuthKbdInt.Retries

#"N/A OpenSSH"
/********************************************************************************************************************************************************************/
AV.1.5.1 Network Settings	"KeyRegenerationInterval"	3600 or less, and must not be 0

cat /etc/ssh/sshd_config | grep -i KeyRegenerationInterval

#"Si sale comentado mirar el MAN y ver el default"

man sshd_config
/KeyRegenerationInterval
/********************************************************************************************************************************************************************/
AV.1.5.2 Network Settings	"Protocol" = "2", 2,1 or "1,2"

sshd -T|grep protocol
grep -i protocol /etc/ssh/sshd_config
grep -i ServerKeyBits /etc/ssh/sshd_config /usr/local/etc/sshd_config

#"Si sale comentado mirar el MAN y ver el default"

man sshd_config
/ServerKeyBits

## el ssh a partir de la la versión OpenSSH_7.4p1 ya no utiliza protocolo 1.##
/********************************************************************************************************************************************************************/
AV.1.5.5 Network Settings	"GatewayPorts" = NO

grep -i GatewayPorts /etc/ssh/sshd_config

#"Si sale comentado mirar el MAN y ver el default"

man sshd_config
/GatewayPorts
/********************************************************************************************************************************************************************/
AV.1.7.1.1 Identify and Authenticate Users	"PermitRootLogin" = NO
AV.1.7.1.2 Identify and Authenticate Users	

cat /etc/ssh/sshd_config | grep -i PermitRootLogin

#"Si sale comentado mirar el MAN y ver el default"

man sshd_config
/PermitRootLogin
####################################################################################AV.1.7.1.2 Identify and Authenticate Users

#"N/A PermitRootLogin no"
/********************************************************************************************************************************************************************/
AV.1.7.2 Identify and Authenticate Users	Public Key Authentication = YES

cat /etc/ssh/sshd_config | grep -i PubkeyAuthentication

#"Si sale comentado mirar el MAN y ver el default"

man sshd_config
/PubkeyAuthentication
/********************************************************************************************************************************************************************/
AV.1.7.3.2 Identify and Authenticate Users
AV.1.7.3.3 Identify and Authenticate Users

grep HostbasedAuthentication /etc/ssh/sshd_config

#"Si sale comentado mirar el MAN y ver el default"

man sshd_config
/HostbasedAuthentication
/********************************************************************************************************************************************************************/
AV.1.8.2.1 Protecting Resources  OSRs
AV.1.8.2.2 Protecting Resources  OSRs
AV.1.8.2.3 Protecting Resources  OSRs
AV.1.8.2.4 Protecting Resources  OSRs
AV.1.8.2.5 Protecting Resources  OSRs
AV.1.8.2.6 Protecting Resources  OSRs
AV.1.8.2.7 Protecting Resources  OSRs
AV.1.8.2.8 Protecting Resources  OSRs
AV.1.8.2.9 Protecting Resources  OSRs
AV.1.8.2.10 Protecting Resources  OSRs
AV.1.8.2.11 Protecting Resources  OSRs
AV.1.8.2.12 Protecting Resources  OSRs
AV.1.8.2.13 Protecting Resources  OSRs
AV.1.8.2.14 Protecting Resources  OSRs
AV.1.8.2.15 Protecting Resources  OSRs
AV.1.8.2.16 Protecting Resources  OSRs
AV.1.8.2.17 Protecting Resources  OSRs
AV.1.8.2.18 Protecting Resources  OSRs
AV.1.8.2.19 Protecting Resources  OSRs
AV.1.8.2.20 Protecting Resources  OSRs
AV.1.8.2.21 Protecting Resources  OSRs
AV.1.8.2.22 Protecting Resources  OSRs
AV.1.8.2.23 Protecting Resources  OSRs
AV.1.8.2.24 Protecting Resources  OSRs
AV.1.8.2.25 Protecting Resources  OSRs
AV.1.8.2.26 Protecting Resources  OSRs
AV.1.8.2.27 Protecting Resources  OSRs
AV.1.8.2.28 Protecting Resources  OSRs
AV.1.8.2.29 Protecting Resources  OSRs
AV.1.8.2.30 Protecting Resources  OSRs
AV.1.8.2.31 Protecting Resources  OSRs
AV.1.8.2.32 Protecting Resources  OSRs
AV.1.8.2.33 Protecting Resources  OSRs
AV.1.8.2.34 Protecting Resources  OSRs
AV.1.8.2.35 Protecting Resources  OSRs
AV.1.8.2.36 Protecting Resources  OSRs
AV.1.8.2.37 Protecting Resources  OSRs
AV.1.8.2.38 Protecting Resources  OSRs
AV.1.8.2.39 Protecting Resources  OSRs
AV.1.8.2.40 Protecting Resources  OSRs
AV.1.8.2.41 Protecting Resources  OSRs
AV.1.8.2.42 Protecting Resources  OSRs
AV.1.8.2.43 Protecting Resources  OSRs
AV.1.8.2.44 Protecting Resources  OSRs
AV.1.8.2.45 Protecting Resources  OSRs
AV.1.8.2.46 Protecting Resources  OSRs
AV.1.8.2.47 Protecting Resources  OSRs
AV.1.8.2.49 Protecting Resources  OSRs
AV.1.8.2.50 Protecting Resources  OSRs
AV.1.8.3.1 Protecting Resources  OSRs
AV.1.8.3.2 Protecting Resources  OSRs
AV.1.8.3.3 Protecting Resources  OSRs
AV.1.8.3.4 Protecting Resources  OSRs
AV.1.8.3.5 Protecting Resources  OSRs
AV.1.8.3.6 Protecting Resources  OSRs
AV.1.8.3.7 Protecting Resources  OSRs
AV.1.8.3.8 Protecting Resources  OSRs
AV.1.8.3.9 Protecting Resources  OSRs
AV.1.8.3.10 Protecting Resources  OSRs


#Comprobar que no tenga escrituras en other, si el fichero o directorio existe#


find /bin/ -type f -perm -o=w | wc -l
find /bin/ -type d -perm -o=w | wc -l

find /lib* -type f -perm -o=w | wc -l
find /lib* -type d -perm -o=w | wc -l

ls -la /sbin/sshd
ls -la /sbin/sshd2
ls -la /sbin/sshd-check-conf
ls -la /lib/svc/method/sshd
ls -la /usr/lib/ssh/sshd
ls -la /etc/openssh/sshd_config
ls -la /etc/ssh/sshd_config
ls -la /etc/ssh/sshd2_config
ls -la /etc/ssh2/sshd_config
ls -la /etc/ssh2/sshd2_config
ls -la /etc/sshd_config
ls -la /etc/sshd2_config
ls -la /usr/local/etc/sshd_config
ls -la /usr/local/etc/sshd2_config
ls -la /usr/lib/ssh/ssh-keysign
/********************************************************************************************************************************************************************/
AV.1.9.1 Protecting Resources - User Resources	"PermitUserEnvironment"

#Aplica a la version del ssh 3.5#

ssh -V

#"N/A OpeSSH#
/********************************************************************************************************************************************************************/
AV.1.9.2 Protecting Resources - User Resources	"StrictModes" = YES

grep StrictModes /etc/ssh/sshd_config

#"Si sale comentado mirar el MAN y ver el default"

man sshd_config
/StrictModes
/********************************************************************************************************************************************************************/
AV.1.9.3 Protecting Resources - User Resources	"AcceptEnv" = TODO COMENTADO

grep AcceptEnv /etc/ssh/sshd_config
/********************************************************************************************************************************************************************/
AV.2.0.1.1 Business Use Notice	Business Use Notice / PrintMotd = yes
AV.2.0.1.4 Business Use Notice

grep -i PrintMotd /etc/ssh/sshd_config
/********************************************************************************************************************************************************************/
AV.2.1.1.2 Encryption
AV.2.1.1.3 Encryption
AV.2.1.1.4 Encryption

sshd -T|grep protocol
grep -i protocol /etc/ssh/sshd_config
grep -i ServerKeyBits /etc/ssh/sshd_config /usr/local/etc/sshd_config

#"Si sale comentado mirar el MAN y ver el default"

man sshd_config
/ServerKeyBits

## el ssh a partir de la la versión OpenSSH_7.4p1 ya no utiliza protocolo 1.##
/********************************************************************************************************************************************************************/
AV.2.2.1.1 Passphrases	Private Key Passphrases

#"lo mismo que AV.1.1.4"
/********************************************************************************************************************************************************************/
##AV.1.1.5 Password Requirements	Private Key Passphrases
##AV.1.1.6 Password Requirements
# YES Informativo
#SIMILAR 
##AV.2.2.1.2 Passphrases
##AV.2.2.1.3 Passphrases
/********************************************************************************************************************************************************************/
AV.2.2.1.4 Passphrases	Private Key Passphrases - security administrative and system authority

#"lo mismo que AV.1.1.7"
/********************************************************************************************************************************************************************/