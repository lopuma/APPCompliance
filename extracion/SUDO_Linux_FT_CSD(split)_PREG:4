///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
SUDO Linux FT CSD - Issue REF : 755098 / PRE 4
##----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------##
---ZY.1.2.3 Logging
"Secondary logging

"Si la configuración de sudo implementado permite a los usuarios o grupos realizar el mandato su, el registro secundario se debe implementar para mantener la responsabilidad individual, a través de un registro que registra los mandatos emitidos por cada individuo."

//Se revisan 2 cosas.
➡ 1 "Que el registro de sudo este implementado

	cat /etc/sudoers | grep -i logfile
	cat /etc/sudoers.d/* | grep -i logfile

	*///Ejemplo
	⏭--> Defaults logfile=/var/adm/sudo.log, log_year, log_host, loglinelen=0 

	//Lanzar un ls del fichero que nos muestra y debe existir
	ls -la /var/adm/sudo.log

➡ 2 "Que existe un registro de comandos(Secondary Longgins)
        //Esto se puede verificar de 2 formas, si cumple cualquiera de las 2 es YES.

        OPCION ➡ 1. //Secondary_logging_IBM.sh, debe existir y contener la ruta, donde se guardan los logs de los comandos por 			     usuario.
        ls -la /etc/profile.d/secondary_logging_IBM.sh 
        cat /etc/profile.d/secondary_logging_IBM.sh | grep -i 'HIST_DIR='
        "Lanzar un ls del fichero que nos muestra
        ls -la /var/log/hist
        
        OPCION ➡ 2. //Segundo, si no existe el fichero IBM.sh, puede estar implementado en /etc/bashrh
        ls -la /etc/bashrc  
        cat /etc/bashrc  | grep -i 'HIST_DIR='
        "Lanzar un ls del fichero que nos muestra
        ls -la /var/log/hist
        //###########################################################################

/*🗒✔  CONTESTAR YES*/  "Si el fichero de sudo.log, existe y esta configurado en el SUDOERS y el SECONDARY LOGGIN esta activo"
/*🗒⛔ CONTESTAR NO*/ : "No tiene implementado el fichero del sudo.log, en la configuracion del SUDOERS. : 					 Defaults logfile=/var/adm/sudo.log, log_year, log_host, loglinelen=0"
/* NO */ 		"The file of the sudo.log, is not the correct one, is configured by default: /var/log/sudo.log, it is 				 recommended to be: /var/adm/sudo.log
##----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------##
---ZY.1.2.4 Logging
"Log retention timeframe 90 DIAS

//Para la rotacion de log`s se revisa 2 cosas.
	OPCION ➡ 1. //La rotacion que debe ser 90 dias.
	OPCION ➡ 2. //El fichero del sudo.log debe estar rotando.

OPCION ➡ 1. //La rotacion debe ser 90 dias.

"Saber que sistema de rotacion USA
⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏
	🔴OPCION ➡ 1. // Si usa logkeeper

	/usr/local/bin/logkeeper -s

	📌#->si no funciona "LOGKEEPER" mirar Logrotate<-#
⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏
	🔴OPCION ➡ 2. // Si usa logrotate.conf

	cat /etc/logrotate.conf

	// La rotacion debe esta definida en semanas 'weekly' a 13:
	cat /etc/logrotate.conf | head -10

	📌#->si no funciona mirar sin LOGKEEPE&sin LOGROTATE<-#
⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏
	🔴OPCION ➡ 3. // Sin logkeeper y Sin logrotate.conf

	cat /usr/local/bin/tareas/rotalogs.ksh | grep -i /var/adm
⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏

OPCION ➡ 2. //El fichero del sudo.log debe estar rotando.

"Saber que SO estamos revisando "dependera del fichero del sudo.log", ya sea Linux o Aix
	// Sudo - Rotacion del log.
	"	Linux - /var/adm/sudo.log
	"	Aix   - /var/adm/sudo.log

// Debe existir una entrada del fichero de sudo en la rotacion(🔴OPCION ➡ 1. LOGKEEPER):
	
	"//La rotacion de log se define en el fichero de configuracion

	cat /usr/local/bin/tareas/logkeeperalt.cfg | egrep -i "trim|backup|sudo"

	//Debe estar implementado:
	"$Trim a 90
	"@backups = /var/adm/sudo.log

	//Y se ejecuta en rotalogs con job de control todos los domingos

	cat /usr/local/bin/tareas/rotalogs.ksh | grep -v "^#"|grep -i logkee

	"Debe existir /usr/local/bin/tareas/logkeeperalt.cfg en el codigo que se ejecuta.

// Debe existir una entrada del fichero de sudo en la rotacion(🔴OPCION ➡ 2. LOGROTATE):

	cat /etc/logrotate.conf | grep -w /var/adm/sudo.log -A7

	//Si la configuracion de rotado para sudo, no existe en logrotate.conf, debe estar implementado en syslog
	cat /etc/logrotate.d/syslog | grep -i sudo

/*🗒✔  CONTESTAR YES*/: "Si esta rotando a 90 y existe el fichero de sudo.log configurado en la rotacion"
/*🗒⛔ CONTESTAR NO*/ : "Si no esta rotando a 90 dias o no existe el fichero de log configurado en la rotacion.".#
/* NO */		"The rotation is configured in XX days, it should be XX days."
##----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------##
---ZY.1.4.4 System Settings
"Logging of commands issued by individuals via sudo
"Mandatos que permiten escapes de shell: (relacionados con ZY.1.4.2.1)
"/*bash2bug, bashbug, ed, ex, ftp, format, less, more, pg, vi, view, vim, gvim, gview, evim, eview, vimdiff, find*/

//La entrada "root ALL = (ALL) ALL" es permitida"

cat /etc/sudoers | grep -v "#" | egrep -i "ALL |= ALL|ALL="
cat /etc/sudoers.d/* | grep -v "^#"| egrep -i "ALL |= ALL|ALL="

*///Ejemplo de Entradas no authorizadas
	⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏
	Entradas no authorizadas.: 
	- essence ALL=(root) ALL
	- essence ALL=(ALL) ALL
	- es082058 ALL=(root) NOPASSWD:/bin/vi, /usr/bin/less.
	Entradas no authorizadas.: 
	- z19423 ALL=(root) NOPASSWD: ALL # UIDPC IT-20190903-001
	⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏

*///Ejemplo de Entrada permitidas "DEFINISION"
	⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏
	%list ALL=(listener) NOPASSWD:/home/listener/scripts/compilacion_XLT_EGF.ksh
	(%List)usuario/grupo (ALL)servidores =(listener)(usuario) NOPASSWD: - no pedira password:COMANDOS A EJecUTAR
	
	// esta entrada, permite todo, pero niega los SHELLSCAPE, es permitido.	
	IBM_DCA_BAU  IBM_DCA_HOSTS = ALL,!IBM_NONE_SA,!IBM_SHELLS_ALL,/bin/su -,\
	cdevdisc ALL=(root) !IBM_SHELLS_ALL,CDEVDISC,!IBM_SHELLESCAPE_ALL
	⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏

/*🗒✔  CONTESTAR YES*/  : "Si no hay entradas de SHELL ESCAPE no authorizadas"

/*🗒⛔ CONTESTAR NO*/   : "Si hay entradas de que no sean "root ALL = (ALL) ALL" o no esten previamente authorizadas" 
			  
/* NO */		"Next entry: "z19423 ALL=(root) NOPASSWD: ALL" in the file /etc/sudoers.d/999_TEMPORARY_ROOT_ACCESS_ENE				 L_SSE: , does not have prior authorization, should be reviewed if entry is required."

/*🗒🔁 CONTESTAR N/A */ : ""
##----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------##
---ZY.1.4.5 System Settings
"Editors used with sudo privileges
"Si en los alias Cmnd_Alias del fichero Sudoers se definen comandos que podrán ser utilizados por grupos de usuarios,si aparece /bin/vi en algunos ,luego en los usuarios a los que se le asigne deberán estar excluidos (con el signo ! por delante).

cd /etc/sudoers.d
grep /bin/vi *

//Los CMD_ALIAS que tienen un vi por defecto son:
	IBM_SHELLESCAPE_ALL
	IBM_NONE_ALL
	IBM_NONE_EDITOR

//Comprobar que los CMD_ALIAS que obtengan un /vi, tenga por delante !. 
	"Lo cual permite excluir cierto valores

cat /etc/sudoers /etc/sudoers.d/* | grep -v "^#"|egrep -i "shellescape|editor|none_all"

*///Ejemplo de CMD_ALIAS, que tienen el signo de negacion '!' por delante, de su definicion"
	⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏
	IBM_DCA_BAU  IBM_DCA_HOSTS = ALL,!IBM_NONE_SA,!IBM_SHELLS_ALL,/bin/su -,\ 
	cdevdisc ALL=(root) !IBM_SHELLS_ALL,CDEVDISC,!IBM_SHELLESCAPE_ALL
	⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏⏏

/*🗒✔  CONTESTAR YES*/: "Si los cmd_alias "IBM_SHELLESCAPE_ALL, IBM_NONE_ALL, IBM_NONE_EDITOR", tiene un "!" o NOEXEC, por 				 delante, al ser definidos"

/*🗒⛔ CONTESTAR NO*/ : "In XXXXXX the entry of the CMD_ALIAS "IBM_SHELLESCAPE_AL" does not have! Ahead, you have to check 				 if it is necessary so or should have!.

/*🗒🔁 CONTESTAR N/A */ : ""
##----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------##
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
